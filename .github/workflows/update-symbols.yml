name: Update Stock Symbols

# ì›Œí¬í”Œë¡œìš° ì„¤ëª…
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ë§¤ì¼ ìë™ìœ¼ë¡œ symbols.json íŒŒì¼ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

on:
  # ìŠ¤ì¼€ì¤„ ì‹¤í–‰: ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 2ì‹œ (UTC 17:00)ì— ì‹¤í–‰
  schedule:
    - cron: '0 17 * * *'  # UTC 17:00 = í•œêµ­ì‹œê°„ ë‹¤ìŒë‚  02:00
  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
  workflow_dispatch:

jobs:
  update-symbols:
    name: Update Stock Symbols JSON
    runs-on: ubuntu-latest  # GitHub Actionsì˜ ë¬´ë£Œ Ubuntu ê°€ìƒ ë¨¸ì‹  ì‚¬ìš©
    
    steps:
      # 1ë‹¨ê³„: ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # ë³€ê²½ì‚¬í•­ì„ ì»¤ë°‹í•˜ê¸° ìœ„í•´ í† í° ê¶Œí•œ í•„ìš”
          token: ${{ secrets.GITHUB_TOKEN }}
          # ê¸°ë³¸ ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒ
          ref: ${{ github.ref }}
      
      # 2ë‹¨ê³„: Python í™˜ê²½ ì„¤ì •
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          # pip ìºì‹œ ì‚¬ìš©ìœ¼ë¡œ ì„¤ì¹˜ ì†ë„ í–¥ìƒ
          cache: 'pip'
      
      # 3ë‹¨ê³„: Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r api/requirements.txt
          # symbols.json ìƒì„±ì— í•„ìš”í•œ ì¶”ê°€ íŒ¨í‚¤ì§€
          pip install requests beautifulsoup4
      
      # 4ë‹¨ê³„: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
      # GitHub Secretsì—ì„œ FINNHUB_API_KEYë¥¼ ê°€ì ¸ì™€ì„œ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •
      - name: Set up environment variables
        env:
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
        run: |
          echo "í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ"
          # API í‚¤ê°€ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸ (ë³´ì•ˆì„ ìœ„í•´ ê¸¸ì´ë§Œ í™•ì¸)
          if [ -z "$FINNHUB_API_KEY" ]; then
            echo "âš ï¸ ê²½ê³ : FINNHUB_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¯¸êµ­ ì£¼ì‹ ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          else
            echo "âœ… FINNHUB_API_KEYê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
          fi
      
      # 5ë‹¨ê³„: symbols.json ìƒì„±
      - name: Generate symbols.json
        env:
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
        run: |
          echo "ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ìƒì„± ì‹œì‘..."
          python3.11 scripts/generate_symbols_json.py
          echo "âœ… symbols.json ìƒì„± ì™„ë£Œ"
      
      # 6ë‹¨ê³„: ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
      - name: Check for changes
        id: check-changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if git diff --quiet public/data/symbols.json; then
            echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ë³€ê²½ì‚¬í•­ ë°œê²¬"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      # 7ë‹¨ê³„: ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ ì»¤ë°‹ ë° í‘¸ì‹œ
      - name: Commit and push changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git add public/data/symbols.json
          git commit -m "ğŸ¤– ìë™ ì—…ë°ì´íŠ¸: ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ê°±ì‹  [$(date +'%Y-%m-%d %H:%M:%S')]"
          git push origin HEAD:${{ github.ref }}
        env:
          # GitHub Actionsì—ì„œ ìë™ìœ¼ë¡œ ì œê³µë˜ëŠ” í† í° ì‚¬ìš©
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # 8ë‹¨ê³„: ì™„ë£Œ ë©”ì‹œì§€
      - name: Summary
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          echo "âœ… symbols.jsonì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ë³€ê²½ì‚¬í•­ì´ ì €ì¥ì†Œì— ì»¤ë°‹ë˜ì—ˆìŠµë‹ˆë‹¤."
      
      - name: No changes
        if: steps.check-changes.outputs.has_changes == 'false'
        run: |
          echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. symbols.jsonì´ ì´ë¯¸ ìµœì‹  ìƒíƒœì…ë‹ˆë‹¤."
