# 데이터 정합성 및 신뢰성 검증 보고서

## 📋 개요

모든 수치 및 지표 계산 로직에 대한 면밀한 검증을 수행한 결과입니다.

---

## 🔍 발견된 문제점 및 수정 사항

### 1. ⚠️ 변동성 계산 버그 (수정 완료)

**문제점:**
- `calculateVolatility` 함수에서 `prices.slice(0, period)` 사용
- 가장 오래된 period개 데이터를 사용하여 변동성 계산
- 수익률 계산 방향이 역방향 (`(recentPrices[i - 1] - recentPrices[i]) / recentPrices[i]`)

**수정 내용:**
- `prices.slice(-period)`로 변경 (최근 period일 사용)
- 수익률 계산을 정방향으로 수정: `(recentPrices[i] - recentPrices[i - 1]) / recentPrices[i - 1]`

**영향:**
- 변동성 지표가 최근 시장 변동성을 정확히 반영하지 못함
- 연율화 변동성도 부정확함

---

### 2. ⚠️ 지지선/저항선 계산 버그 (수정 완료)

**문제점:**
- `calculateSupportResistance` 함수에서 `historicalData.slice(0, period)` 사용
- 가장 오래된 period개 데이터를 사용하여 저항선/지지선 계산
- `currentPrice`를 `data[0].close`로 사용 (가장 오래된 가격)

**수정 내용:**
- `historicalData.slice(-period)`로 변경 (최근 period일 사용)
- `currentPrice`를 `recentData[recentData.length - 1].close`로 변경 (최신 가격)

**영향:**
- 저항선/지지선이 과거 데이터를 기반으로 계산되어 현재 시장 상황과 불일치
- 현재 위치 판단이 부정확함

---

### 3. ⚠️ 눌림목 여부 판단 버그 (수정 완료)

**문제점:**
- `detectSupportLevel` 함수에서 `historicalData.slice(0, period)` 사용
- 가장 오래된 period개 데이터를 사용하여 지지선 계산

**수정 내용:**
- `historicalData.slice(-period)`로 변경 (최근 period일 사용)

**영향:**
- 눌림목 판단이 과거 데이터를 기반으로 하여 부정확함

---

### 4. ✅ 데이터 순서 일관성 보장 (수정 완료)

**문제점:**
- `historicalData`가 항상 "과거 → 최신" 순서로 정렬되어 있다는 가정
- Yahoo Finance와 Finnhub 데이터 순서가 다를 수 있음

**수정 내용:**
- `lib/finance.ts`: `historical` 데이터를 날짜 기준으로 정렬
- `lib/finance-finnhub.ts`: Finnhub candle과 Yahoo Finance fallback 모두 날짜 기준 정렬
- `app/api/analyze/route.ts`: `historicalData` 사용 전 날짜 기준 정렬 보장

**영향:**
- 모든 지표 계산이 일관된 데이터 순서를 사용하여 정확성 향상

---

## ✅ 검증 완료된 지표

### 1. RSI (상대강도지수)

**계산 방식:**
- Wilder's Smoothing 방식 사용
- 데이터 순서: "과거 → 최신" 가정 ✅
- 초기 평균: `gains.slice(0, period)` 사용 (올바름)
- 검증: 0-100 범위 체크 ✅

**신뢰도:** ⭐⭐⭐⭐⭐

---

### 2. 이동평균선 (MA5, MA20, MA60, MA120)

**계산 방식:**
- Simple Moving Average
- `prices.slice(-period)` 사용 (최근 period일) ✅
- 데이터 부족 시 `null` 반환 ✅

**신뢰도:** ⭐⭐⭐⭐⭐

---

### 3. 이격도

**계산 방식:**
- `(현재가 / 이동평균) × 100`
- `movingAverage === 0` 체크 ✅

**신뢰도:** ⭐⭐⭐⭐⭐

---

### 4. 볼린저 밴드

**계산 방식:**
- 중심선: 20일 이동평균
- 상단/하단: 중심선 ± (표준편차 × 2)
- `prices.slice(-period)` 사용 (최근 period일) ✅
- `currentPrice` 파라미터로 최신 가격 사용 ✅

**신뢰도:** ⭐⭐⭐⭐⭐

---

### 5. 거래량 지표

**계산 방식:**
- `latestVolume` 파라미터로 최신 거래량 사용 ✅
- `volumes.slice(-period)` 사용 (최근 period일) ✅
- 평균 대비 비율 계산 정확 ✅

**신뢰도:** ⭐⭐⭐⭐⭐

---

### 6. ETF 괴리율

**계산 방식:**
- `((시장 가격 - NAV) / NAV) × 100`
- `nav === 0` 체크 ✅
- Symbol 기반 필터링으로 일반 주식 제외 ✅

**신뢰도:** ⭐⭐⭐⭐⭐

---

## ⚠️ 추가 검증 필요 사항

### 1. 데이터 소스 간 일관성

**현재 상태:**
- `data-consistency-checker.ts`에서 Finnhub + Yahoo Finance 혼합 시 정합성 검증 ✅
- 타임스탬프 차이 24시간 이내 확인 ✅
- 가격 차이 5% 이상 시 경고, 20% 이상 시 오류 ✅

**개선 사항:**
- 데이터 소스가 다를 때 자동으로 일관성 검증 수행
- 불일치 시 자동 fallback 또는 경고

---

### 2. 데이터 유효성 검증

**현재 상태:**
- `data-validator.ts`에서 기본 검증 수행 ✅
- null, undefined, NaN 체크 ✅
- RSI 범위 체크 (0-100) ✅
- Historical 데이터 포인트별 검증 ✅

**개선 사항:**
- 가격 변동이 비정상적으로 큰 경우 (예: 50% 이상 일일 변동) 경고
- 거래량이 0인 경우 처리 개선

---

### 3. 계산 결과 범위 검증

**현재 검증:**
- RSI: 0-100 범위 경고 ✅
- 이격도: 0-500 범위 경고 ✅

**추가 필요:**
- 볼린저 밴드: 상단 > 중심선 > 하단 검증
- 변동성: 0-100% 범위 검증
- 거래량 비율: 0 이상 검증

---

## 📊 데이터 소스 신뢰도 평가

### 1. Yahoo Finance

**신뢰도:** ⭐⭐⭐ (보통)

**장점:**
- 광범위한 종목 커버리지
- Historical 데이터 제공

**단점:**
- 비공식 API (Rate Limit 불명확)
- 데이터 정합성 검증 필요

**검증 상태:**
- ✅ null, NaN, 음수 체크
- ✅ 데이터 순서 정렬 보장
- ⚠️ Rate Limit 대응 필요

---

### 2. Finnhub

**신뢰도:** ⭐⭐⭐⭐ (양호)

**장점:**
- 공식 API
- Quote 데이터 정확도 높음

**단점:**
- 무료 플랜 제한 (Candle API 제한)
- Yahoo Finance fallback 필요

**검증 상태:**
- ✅ Quote + Historical 정합성 검증
- ✅ 데이터 순서 정렬 보장
- ✅ Fallback 메커니즘

---

### 3. KRX Open API

**신뢰도:** ⭐⭐⭐⭐⭐ (우수)

**장점:**
- 공식 API
- 한국 주식 데이터 정확도 높음

**단점:**
- API 키 필요
- ETF 전용 (일반 주식은 다른 소스 사용)

**검증 상태:**
- ✅ Symbol 기반 필터링
- ✅ NAV 검증 (0 체크)

---

## 🔧 개선 완료 사항

1. ✅ 변동성 계산: 최근 데이터 사용, 수익률 계산 방향 수정
2. ✅ 지지선/저항선: 최근 데이터 사용, 현재가 정확히 반영
3. ✅ 눌림목 여부: 최근 데이터 사용
4. ✅ 데이터 순서: 모든 소스에서 날짜 기준 정렬 보장
5. ✅ 거래량 지표: 최신 거래량 정확히 반영

---

## 📝 권장 사항

### 1. 실시간 검증 로그 추가

각 지표 계산 시 다음 정보를 로그로 출력:
- 사용된 데이터 포인트 수
- 계산 결과 범위
- 이상치 감지

### 2. 단위 테스트 추가

각 지표 계산 함수에 대한 단위 테스트 작성:
- 정상 케이스
- 경계 케이스 (데이터 부족, 0 값 등)
- 이상 케이스 (NaN, null 등)

### 3. 데이터 품질 메트릭 강화

`data-metrics.ts`에 다음 메트릭 추가:
- 지표 계산 실패율
- 데이터 소스별 정확도
- 이상치 발생 빈도

---

## ✅ 최종 평가

**전체 신뢰도:** ⭐⭐⭐⭐ (양호)

**주요 개선 사항:**
- 데이터 순서 일관성 보장
- 최근 데이터 기반 계산으로 정확도 향상
- 검증 로직 강화

**남은 작업:**
- 실시간 검증 로그 추가
- 단위 테스트 작성
- 데이터 품질 메트릭 강화
